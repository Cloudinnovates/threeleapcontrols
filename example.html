<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Three.js ・ Leap Controls</title>
    <meta charset="utf-8">
    <meta name="author" content="Torsten Sprenger">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link href='http://fonts.googleapis.com/css?family=Fauna+One' rel='stylesheet' type='text/css'>
    <style type="text/css" media="screen">
      body {
        font-family: 'Fauna One', serif;
        font-size: 12px;
      }

      h3 {font-weight: normal;}

      a {color: red;}

      #info {
        position: absolute;
        width: 700px;
        margin-left: -350px;
        left: 50%;
        text-align: center;
        overflow: hidden;
        z-index: 1;
      }

      #container {
        position: absolute;
        display: block;
        height: auto;
        width: auto;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        margin: 5px;
        overflow: hidden;
        border: 1px solid #cccccc;
        z-index: 0;
      }

      canvas {
        display: block;
        margin: auto;
        width: 100%;
      }

      #overlay {
        display: none;
        position: absolute;
        color: #333333;
        z-index: 2;
        width: 400px;
        height: 100px;
        margin-left: -200px;
        margin-top: -50px;
        top: 50%;
        left: 50%;
        text-align: center;
        font-weight: bold;
        font-size: 26px;
      }
    </style>
    <script src="js/Detector.js"></script>
    <script src="js/jquery.min.js"></script>
    <script src="js/three.min.js"></script>
    <script src="js/leap.min.js"></script>
    <script src="LeapControls.js"></script>
    <script src="LeapObjectControls.js"></script>
    <script>
      var camera, controls, scene, renderer;
      var coords1, coords2, coords3;

      function init() {
        // is webgl supported?
        if (!Detector.webgl) {
          Detector.addGetWebGLMessage();
          return false;
        };

        // renderer
        renderer = new THREE.WebGLRenderer({antialias: true});
        renderer.setSize(window.innerWidth, window.innerHeight);
        var container = document.getElementById('container');
        container.appendChild(renderer.domElement);

        // camera
        camera = new THREE.PerspectiveCamera(25, window.innerWidth / window.innerHeight, 0.1, 10000);
        camera.position.x = 350;
        camera.position.y = 350;
        camera.position.z = 350;
        var origin = new THREE.Vector3(0, 0, 0);
        camera.lookAt(origin);

        // leap camera controls
        var speedFactor = 2;
        controls = new THREE.LeapControls(camera);

        controls.rotateEnabled  = true;
        controls.rotateSpeed    = speedFactor*1.5;
        controls.rotateHands    = 1;
        controls.rotateFingers  = [2, 3];
        
        controls.zoomEnabled    = true;
        controls.zoomSpeed      = speedFactor*3.0;
        controls.zoomHands      = 1;
        controls.zoomFingers    = [4, 5];
        controls.zoomMin        = 50;
        controls.zoomMax        = 2000;
        
        controls.panEnabled     = true;
        controls.panSpeed       = speedFactor*1.0;
        controls.panHands       = 2;
        controls.panFingers     = [6, 12];
        controls.panRightHanded = false; // for left-handed person

        // world
        scene = new THREE.Scene();        

        // camera target coordinate system
        coords1 = new THREE.ArrowHelper(new THREE.Vector3(1, 0, 0), origin, 75, 0xcccccc);
        coords2 = new THREE.ArrowHelper(new THREE.Vector3(0, 1, 0), origin, 75, 0xcccccc);
        coords3 = new THREE.ArrowHelper(new THREE.Vector3(0, 0, 1), origin, 75, 0xcccccc);
        scene.add(coords1);
        scene.add(coords2);
        scene.add(coords3);

        // world coordinate system (thin dashed helping lines)
        var lineGeometry = new THREE.Geometry();
        var vertArray = lineGeometry.vertices;
        vertArray.push(new THREE.Vector3(1000, 0, 0), origin, new THREE.Vector3(0, 1000, 0), origin, new THREE.Vector3(0, 0, 1000));
        lineGeometry.computeLineDistances();
        var lineMaterial = new THREE.LineDashedMaterial({color: 0xcccccc, dashSize: 1, gapSize: 2});
        var coords = new THREE.Line(lineGeometry, lineMaterial);
        scene.add(coords);

        // material for torus knot
        var solidMaterial = new THREE.MeshLambertMaterial({color: 0xefefef});
        var wireframeMaterial = new THREE.MeshBasicMaterial({color: 0x555555, wireframe: true, transparent: true}); 
        var material = [solidMaterial, wireframeMaterial]; 

        // torus knot
        var torus = THREE.SceneUtils.createMultiMaterialObject(new THREE.TorusKnotGeometry(28, 6, 400, 25, 2, 3), material);
        var torus = new THREE.Mesh(new THREE.CubeGeometry(80, 80, 80), new THREE.MeshNormalMaterial());
        // torus.rotation.x = Math.PI/2;
        scene.add(torus);
        torus.position.x = 50;
        torus.position.y = 70;
        torus.position.z = -100;
        torus.rotation.x = 50;
        torus.rotation.y = 70;
        torus.rotation.z = -100;

        // torus.rotation.z = 2;
        // camera.lookAt(new THREE.Vector3(270, -10, -55));
        object_controls = new THREE.LeapObjectControls(torus, camera);

        object_controls.rotateEnabled  = true;
        object_controls.rotateSpeed    = speedFactor*1.5;
        object_controls.rotateHands    = 1;
        object_controls.rotateFingers  = [2, 3];
        
        object_controls.zoomEnabled    = true;
        object_controls.zoomSpeed      = speedFactor*3.0;
        object_controls.zoomHands      = 1;
        object_controls.zoomFingers    = [4, 5];
        object_controls.zoomMin        = 50;
        object_controls.zoomMax        = 2000;
        
        object_controls.panEnabled     = true;
        object_controls.panSpeed       = speedFactor*3.0;
        object_controls.panHands       = 2;
        object_controls.panFingers     = [6, 12];
        object_controls.panRightHanded = false; // for left-handed person


        // light
        var light = new THREE.PointLight(0xefefef);
        light.position = camera.position;
        scene.add(light);

        // listen to resize event
        window.addEventListener('resize', onWindowResize, false);

        // render (if no leap motion controller is detected, then this call is needed in order to see the plot)
        render();

        // leap loop
        var switchControls;
        Leap.loop(function(frame) {
          if (detectClap(frame)) console.log('clapped');

                //   $("#overlay").html("Switched to object mode!");
                //   $("#overlay").show().fadeOut(2000);
                //   switchControls = true;
                // } else {                
                //   $("#overlay").html("Switched to global mode!");
                //   $("#overlay").show().fadeOut(2000);
                //   switchControls = false;
                // }

          // torus.rotation.y += 0.01;

          // custom modifications (here: show coordinate system always on target)
          coords1.position = controls.target;
          coords2.position = controls.target;
          coords3.position = controls.target;

          // update scene
          if (!switchControls) {
            object_controls.update(frame);
          } else {
            controls.update(frame);  
          }
          render();
        });                 
      };

      function detectSwipe(frame) {
        if (frame.hands.length == 2) {
          var h1 = frame.hands[0];
          var h2 = frame.hands[1];
          var lh, rh;
          if (h1.palmPosition.x < h2.palmPosition.x) {
            lh = h1;
            rh = h2;
          } else {
            lh = h2;
            rh = h1;
          };
          if (lh.palmVelocity[0] > 200 && rh.palmVelocity[0] < -200) return true;
        };
        return false;
      }

      function render() {
        renderer.render(scene, camera);
      };

      function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
        render();
      };
    </script>   
  </head>

  <body onload="init()">
    <div id="info">
      <h3><b>threeleapcontrols</b> ・ <a href="http://leapmotion.com">Leap</a> Controls for <a href="http://threejs.org" target="_blank">Three.js</a></h3>
      <b>ROTATING</b> ➞ 1 Hand &amp; 2-3 Fingers ・  <b>ZOOMING</b> ➞ 1 Hand &amp; 4-5 Fingers  ・  <b>PANNING</b> ➞ 2 Hands &amp; 6-10 Fingers
    </div>
    <div id="container"></div>
    <div id="overlay"></div>
  </body>
</html>
